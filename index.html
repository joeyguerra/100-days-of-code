<!DOCTYPE html>
<html>
    <head>
        <title>100 Days of Code</title>
        <style>
            label {
                display: block;
            }

            input {
                display: block;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>100 Days of Code</h1>
        </header>
        <main>
            <form id="formView">
                <label for="name">Just something to save</label>
                <input type="text" name="item" placeholder="Put something in here to save to the list" />
                <button type="submit">Submit</button>
            </form>
            <ul id="stuffToDosView"></ul>
        </main>
        <footer>

        </footer>
    </body>
    <script>
        class KeyValueObservable {
            constructor(observable = {}){
                this.dependents = {};
                observable = observable || {};
                const changed = this.changed.bind(this);
                const cached = Object.assign({}, observable);
                Object.keys(observable).forEach(key => {
                    Reflect.defineProperty(this, key, {
                        get(){
                            return cached[key];
                        },
                        set(value){
                            const old = cached[key];
                            cached[key] = value;
                            changed(key, old, value);
                        }
                    })
                })
            }
            changed(key, old, value){
                if(!this.dependents[key]) return;
                this.dependents[key]?.forEach(o=>o.update(key, old, value));
            }
            observe(key, dependent){
                if(!this.dependents[key]) this.dependents[key] = [];
                this.dependents[key].push(dependent);
            }
            commit(){

            }
        }

        class ObservableList extends Array{
            constructor(...args) {
                super(...args);
                this.observable = new KeyValueObservable(null);
            }
            pop(){
                let last = super.pop();
                this.observable.changed("pop", last, null);
                return last;
            }
            push(item){
                super.push(item);
                this.observable.changed("push", null, item);
            }
            shift(){
                let first = super.shift();
                this.observable.changed("shift", null, first);
                return first;
            }
            unshift(...items){
                super.unshift(...items);
                this.observable.changed("unshift", null, items);
                return items.length;
            }
            observe(key, observer){
                this.observable.observe(key, observer);
            }
        }

        class AddItemCommand {
            constructor(item, utcTimeInms){
                this.item = item;
                this.utcTimeInms = utcTimeInms;
            }
        }

        class TextView {
            constructor(container, events, commands){
                this.container = container;
                this.events = events;
                this.commands = commands;
                this.events.observe("push", this);
            }
            update(key, old, value){
                if(value.target != this.container) return;
                if(!(value instanceof(KeyboardEvent))) return;
                if(value.key == "Enter" && this.container.value.length > 0){
                    this.commands.push(new AddItemCommand(this.container.value, new Date().getTime()));
                    this.container.value = "";
                }
            }
        }
        class ListView {
            constructor(container, events, commands){
                this.container = container;
                this.events = events;
                this.commands = commands;
                this.commands.observe("push", this);
            }
            update(key, old, value){
                if(!(value instanceof AddItemCommand)) return;
                this.addNewItem(value.item);
            }
            addNewItem(item){
                this.container.innerHTML += `<li>${item}</li>`;
            }

        }
        class FormView {
            constructor(container, events, delegate){
                this.container = container;
                this.events = events;
                this.delegate = delegate;
                this.events.observe("push", this);
            }
            update(key, old, value){
                if(value.target.parentNode != this.container) return;
                if(value.type != "click") return;
                value.preventDefault();
            }
        }

        const events = new ObservableList();
        const commands = new ObservableList();
        const t = new TextView(document.querySelector("[name='item']"), events, commands);
        const f = new FormView(document.getElementById("formView"), events);
        const l = new ListView(document.getElementById("stuffToDosView"), events, commands);
        ["click", "keyup"].forEach(event => document.addEventListener(event, e => events.push(e), true));
/*
        f(events) -> state
            match f(state, event) -> state

        f(state, command) -> events
*/
    </script>
</html>