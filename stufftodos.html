<!DOCTYPE html>
<html>
    <head>
        <title>100 Days of Code: Stuff Todos</title>
        <link href="main-layout.css" rel="stylesheet">
    </head>
    <body>
        <header>
            <h1>Stuff Todos</h1>
        </header>
        <nav>
            <h2>Site Nav</h2>
            <ul>
                <li><a href="index.html" title="Home">Home</a></li>
                <li>Time Tracker</li>
                <li>Web Shop</li>
                <li>Stuff Todos</li>
            </ul>
        </nav>
        <main>
            <form id="formView">
                <label for="name" id="formView_label">Just something to save</label>
                <input type="text" id="formView_item" name="item" placeholder="Put something in here to save to the list" />
                <button type="submit" id="formView_submit">Submit</button>
            </form>
            <ul id="listView"></ul>
        </main>
        <footer>
        </footer>
    </body>
    <script>
        class KeyValueObservable {
            constructor(observable = {}){
                this.dependents = {};
                observable = observable || {};
                const changed = this.changed.bind(this);
                const cached = Object.assign({}, observable);
                Object.keys(observable).forEach(key => {
                    Reflect.defineProperty(this, key, {
                        get(){
                            return cached[key];
                        },
                        set(value){
                            const old = cached[key];
                            cached[key] = value;
                            changed(key, old, value);
                        }
                    })
                })
            }
            changed(key, old, value){
                if(!this.dependents[key]) return;
                this.dependents[key]?.forEach(o=>o.update(key, old, value));
            }
            observe(key, dependent){
                if(!this.dependents[key]) this.dependents[key] = [];
                this.dependents[key].push(dependent);
            }
            commit(){

            }
        }

        class ObservableLog extends Array{
            constructor(...args) {
                super(...args);
                this.observable = new KeyValueObservable(null);
            }
            append(item){
                super.push(item);
                this.observable.changed("append", null, item);
            }
            observe(key, observer){
                this.observable.observe(key, observer);
            }
        }
        class ObservableList extends Array{
            constructor(...args) {
                super(...args);
                this.observable = new KeyValueObservable(null);
            }
            push(item){
                super.push(item);
                this.observable.changed("push", null, item);
            }
            pop(){
                const item = super.pop();
                this.observable.changed("pop", null, item);
                return item;
            }
            remove(d){
                let i = 0;
                let ubounds = this.length;
                let deleted = [];
                for(i; i<ubounds;i++){
                    if(d(this[i], i)){
                        deleted = this.splice(i, 1);
                        this.delegate.changed("remove", deleted[0], i);
                        break;
                    }
                }
                return deleted[0];
            }
            observe(key, observer){
                this.observable.observe(key, observer);
            }
        }

        class TextView {
            constructor(container, model, delegate){
                this.container = container;
                this.model = model;
                this.delegate = delegate;
            }
        }
        class ButtonView {
            constructor(container, model, delegate){
                this.container = container;
                this.model = model;
                this.delegate = delegate;
            }
        }
        class ListView {
            constructor(container, model, delegate){
                this.container = container;
                this.model = model;
                this.delegate = delegate;
                this.delegate.events.observe("append", this);
            }
            update(key, old, value){
                if(value instanceof SubmitNewItemRequest){
                    this.addNewItem(value);
                    this.delegate.events.append(new ItemWasAdded(value.item, value.id));
                }
                if(value instanceof DeleteItemRequest){
                    this.remove(value.id);
                    this.delegate.events.append(new ItemWasDeleted(value.item, value.id));
                }
            }
            remove(id){
                this.container.removeChild(this.container.querySelector(`#item_${id}`));
            }
            addNewItem(value){
                this.container.innerHTML += `<li id="item_${value.id}"><span ondblclick="this.contentEditable=true" onblur="this.contentEditable=false;app.events.append(new UpdateItemRequest(this.innerText, ${value.id}));">${value.item}</span><button onclick="app.events.append(new DeleteItemRequest(${value.id}));" title="delete">Delete</button></li>`;
            }
        }
        class ItemWasAdded {
            constructor(item, id){
                this.item = item;
                this.id = id;
                this.timestamp = new Date().getTime();
            }
        }
        class ItemWasDeleted {
            constructor(item, id){
                this.item = item;
                this.id = id;
                this.timestamp = new Date().getTime();
            }
        }

        class SubmitNewItemRequest {
            constructor(newItem){
                this.item = newItem;
                this.id = new Date().getTime();
                this.timestamp = new Date().getTime();
            }
        }
        class DeleteItemRequest {
            constructor(id){
                this.id = id;
                this.timestamp = new Date().getTime();
            }
        }
        class UpdateItemRequest {
            constructor(content, id){
                this.id = id;
                this.contnet = content;
                this.timestamp = new Date().getTime();
            }
        }
        class FormView {
            constructor(container, model, delegate){
                this.container = container;
                this.model = model;
                this.delegate = delegate;
                this.views = [];
                this.views.push(new TextView(this.container.querySelector("#formView_item"), this.model, this));
                this.views.push(new ButtonView(this.container.querySelector("#formView_button"), null, this));
                this.container.addEventListener("submit", this.submit.bind(this), true);
            }
            submit(e){
                e.preventDefault();
                const view = this.views.find(v => v instanceof TextView);
                this.model.newItem = view.container.value;
                if(this.model.newItem.length == 0) return;
                this.delegate.events.append(new SubmitNewItemRequest(this.model.newItem));
                this.model.newItem = "";
                view.container.value = "";
            }
        }
        const model = new KeyValueObservable({
            newItem: ""
        });
        const app = {
            views: new ObservableList(),
            events: new ObservableLog()
        };
        app.views.push(new FormView(document.getElementById("formView"), model, app));
        app.views.push(new ListView(document.getElementById("listView"), model, app));
    </script>
</html>